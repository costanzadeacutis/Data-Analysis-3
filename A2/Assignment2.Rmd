---
title: "airbnb-milano-analysis"
author: "costanzadeacutis"
date: "2023-02-01"
output: 
  html_document: 
    keep_md: yes
---

```{r setup, include=FALSE}
rm(list=ls())

source("functions.R")
source("theme_bg.R")

# Import libraries
library(tidyverse)
library(lspline)
library(cowplot)
library(ggplot2)
library(boot)
library(estimatr)
library(huxtable)
library(stargazer)
library(modelsummary)
library(janitor)
library(fixest)
library(grid)
library(caret)
library(skimr)
library(psych)
library(directlabels)
library(xtable)
library(glmnet)
library(knitr)
library(dplyr)
library(kableExtra)
library(ranger)
knitr::opts_chunk$set(echo = TRUE)

#folder to save graphs, files .tex etc
output <- "output/"
```

# Setup
For the purpose of the analysis, I retain only those that can be defined as apartments in terms of property type.

I create factors from room_type variable, and I categorize it as factor variable together with f_municipio.
I remove apartments that are categorized as outside, i.e. not in one of the 9 municipi, hence not directly comparable with the others (I assume that the apartments whose prices I am trying to predict are all in the city).
I also retain only those apartments that can accommodate 2-6 guests, as the new apartments in question.

NB: Municipio - Given that the neighboorhoods are too many and too small, I regrouped them in "municipi": this categorization comes from comune.milano.it. I then factorize them.
Note: municipio_2_9 is area between Municipio 2 and Municipio 9, that could not be categorized in any of the two.

```{r data}
data <- read.csv("airbnb_milano_cleaned.csv")

#check property types
table(data$property_type)
#keep only apartments
#excluded private room cause not clear
data <- data %>% filter(property_type %in% c("Entire condo", "Entire home", "Entire home/apt", "Entire loft", "Entire place", "Entire rental unit", "Entire serviced apartment", "Entire vacation home", "Private room in condo", "Private room in home", "Private room in loft", "Private room in rental unit", "Private room in serviced apartment", "Private room in tiny home", "Private room in vacation home", "Room in serviced apartment", "Shared room in condo", "Shared room in home", "Shared room in loft", "Shared room in rental unit", "Tiny home"))

#check room types
table(data$room_type)
#remove hotel room
data <- data %>% filter(room_type %in% c("Entire home/apt", "Private room", "Shared room"))
#factor
data <- data %>% mutate(f_room_type = factor(room_type))

#categorical variables
categoricals <- c("f_room_type", "f_municipio")

for (i in 1:length(categoricals)) {
  data %>%
    group_by(get(categoricals[i])) %>%
    summarise(mean_price = mean(price) ,  n=n()) %>%
    print
}

#drop "outside" (not in the city center)
data <- data %>% filter(!(f_municipio %in% c("Outside")))

#number accommodates
data <- data %>% filter(n_accommodates %in% c(2,3,4,5,6))

#drop unused first column
drops <- c("X")
data <- data[ , !(names(data) %in% drops)]
```

## First look at the data
I have a dataset with 16833 observations and 77 variables. Some of these variables have some/many missing values: review_scores_rate, p_host_acceptance_rate, p_host_response_rate, n_days_since, n_bathrooms, f_bathrooms_type, n_beds, n_bedrooms, n_reviews_per_month

```{r first look}
glimpse(data)
skim(data)

# where do we have missing variables now?
to_filter <- sapply(data, function(x) sum(is.na(x)))
to_filter[to_filter > 0]
```

## Further cleaning - Deal with NAs
There are different ways of dealing with missing values:
1. remove when it is the target variable
2. remove those variables that have too many NAs and the variable is not that important for the analysis
3. input values (for beds, assume that the number is the same as the number of accommodates)
4. replace with median and flag when there are many but the variable is important for the analysis
```{r cleaning}
# 1. drop NA if target variable
data <- data %>%
  drop_na(price)

# 2. remove when too many
to_drop <- c("f_bathrooms_type", "p_host_response_rate", "p_host_acceptance_rate", "property_type")
data <- data %>%
  select(-one_of(to_drop))

# 3. imput when few, not that important
#bathrooms
#beds
data <- data %>%
  mutate(
    n_bathrooms =  ifelse(is.na(n_bathrooms), median(n_bathrooms, na.rm = T), n_bathrooms),
    n_beds = ifelse(is.na(n_beds), n_accommodates, n_beds)) #assume n_beds=n_accommodates

to_filter <- sapply(data, function(x) sum(is.na(x)))
to_filter[to_filter > 0]


# 4. Replace missing variables + add flags
#reviews
#bedrooms
#days since
data <- data %>%
  mutate(flag_bedrooms=ifelse(is.na(n_bedrooms),1, 0),
    n_bedrooms =  ifelse(is.na(n_bedrooms), median(n_bedrooms, na.rm = T), n_bedrooms),
    flag_days_since=ifelse(is.na(n_days_since),1, 0),
    n_days_since =  ifelse(is.na(n_days_since), median(n_days_since, na.rm = T), n_days_since),
    flag_review_scores_rating=ifelse(is.na(review_scores_rating),1, 0),
    review_scores_rating =  ifelse(is.na(review_scores_rating), median(review_scores_rating, na.rm = T), review_scores_rating),
    flag_reviews_per_month=ifelse(is.na(n_reviews_per_month),1, 0),
    n_reviews_per_month =  ifelse(is.na(n_reviews_per_month), median(n_reviews_per_month, na.rm = T), n_reviews_per_month)
          )
table(data$flag_days_since)
```

## Create variables polynomials
- measuring the time since: squared, cubic, logs
- squared accommodates
- log ratings
```{r create variables}
data <- data %>%
  mutate(
    ln_days_since = log(n_days_since+1),
    ln_days_since2 = log(n_days_since+1)^2,
    ln_days_since3 = log(n_days_since+1)^3 ,
    n_days_since2=n_days_since^2,
    n_days_since3=n_days_since^3,
    n_accommodates2 = n_accommodates^2,
    ln_review_scores_rating = log(review_scores_rating),
    ln_days_since=ifelse(is.na(ln_days_since),0, ln_days_since),
    ln_days_since2=ifelse(is.na(ln_days_since2),0, ln_days_since2),
    ln_days_since3=ifelse(is.na(ln_days_since3),0, ln_days_since3),
  )
```


# Descriptive analysis
## Prices
The prices for these apartments range from 9 to 90180 dollars per night. Probably both the very low and the very high prices are either anomalies or were wrongly imputed, especially the very high ones. Very extreme prices would be difficult to predict.
Given these considerations, I retain only those prices above 20 and below 1500 dollars per night. The resulting dataset has 16700 observations and 90 variables, after some further data cleaning and feature engineering.
I first look at how the average price moves in terms of Municipio and room type. As expected, highest prices are in Municipio 1 (which is the core of the city) and for entire apartments/home.
I analyze the histograms for prices in levels and logs: the distribution of prices in levels is right-skewed, meaning that there are very few high prices; the log transformation gives a normally shaped distribution. Moreover, for better visualization, I only prices below 400 dollars per night, and this time I look at percentages. The same evaluation as before applies.
Finally I look at apartment price distribution by room type: it is clear that the entire apartments are priced the highest, the shared rooms the lowest, as expected.

```{r prices, warning=FALSE}
#Prices
summary(data$price)
describe(data$price)

#drop very weird prices above 1500 and below 20
data <- data %>% filter(price <= 1500,
                        price > 20)

data <- data %>%
  mutate(ln_price = log(price))

#How is the average price changing by `room_type` and the `municipio`?
data %>%
  group_by(f_municipio, f_room_type) %>%
  dplyr::summarize(mean_price = mean(price, na.rm=TRUE))

Hmisc::describe(data$price)

# Histograms
Airbnb_price <- ggplot(data, aes(price)) +
  geom_histogram(binwidth = 25, fill = color[1], color = color.outline, alpha = 0.8, size = 0.25) +
  ylab("count") +
  xlab("Price") +
  theme_bg()
Airbnb_price

Airbnb_lnprice <- ggplot(data, aes(ln_price)) +
  geom_histogram(binwidth = 0.15, fill = color[1], color = color.outline, alpha = 0.8, size = 0.25) +
  ylab("Count") +
  xlab("Log price") +
  theme_bg()
Airbnb_lnprice

# Look even closer, consider only prices below 400
datau <- subset(data, price<400)

# Histograms
# price
Airbnb_price_percent <- ggplot(data=datau, aes(x=price)) +
  geom_histogram_da(type="percent", binwidth = 10) +
  labs(x = "Price (US dollars)",y = "Percent")+
  scale_y_continuous(expand = c(0.00,0.00),limits=c(0, 0.15), breaks = seq(0, 0.15, by = 0.03), labels = scales::percent_format(1)) +
    scale_x_continuous(expand = c(0.00,0.00),limits=c(0,400), breaks = seq(0,400, 50)) +
  theme_bw() 
Airbnb_price_percent
save_fig("Airbnb-price-percent", output, "small")


# lnprice
Airbnb_price_percent<- ggplot(data=datau, aes(x=ln_price)) +
  geom_histogram_da(type="percent", binwidth = 0.18) +
  #  geom_histogram(aes(y = (..count..)/sum(..count..)), binwidth = 0.18,
  #               color = color.outline, fill = color[1], size = 0.25, alpha = 0.8,  show.legend=F,  na.rm=TRUE) +
  coord_cartesian(xlim = c(2.5, 6.5)) +
  scale_y_continuous(expand = c(0.00,0.00),limits=c(0, 0.15), breaks = seq(0, 0.15, by = 0.05), labels = scales::percent_format(5L)) +
  scale_x_continuous(expand = c(0.00,0.01),breaks = seq(2.4,6.6, 0.6)) +
  labs(x = "ln(price, US dollars)",y = "Percent")+
  theme_bw() 
Airbnb_price_percent
save_fig("Airbnb-price-percent", output, "small")


## Boxplot of price by room type
Airbnb_room_type <- ggplot(data = datau, aes(x = f_room_type, y = price)) +
  stat_boxplot(aes(group = f_room_type), geom = "errorbar", width = 0.3,
               color = c(color[2],color[1], color[3]), size = 0.5, na.rm=T)+
  geom_boxplot(aes(group = f_room_type),
               color = c(color[2],color[1], color[3]), fill = c(color[2],color[1], color[3]),
               size = 0.5, width = 0.6, alpha = 0.3, na.rm=T, outlier.shape = NA) +
  scale_y_continuous(expand = c(0.01,0.01),limits = c(0,400), breaks = seq(0,400,100)) +
  labs(x = "Room type",y = "Price (US dollars)")+
  theme_bg()
Airbnb_room_type
save_fig("Airbnb_room_type", output, "small")

```

## Number of accommodates
It can be seen from both the graph and the table that the mean price increases as the number of accommodates increase, as expected.

```{r accommodates}
## n_accommodates: look at distribution

data %>%
  group_by(n_accommodates) %>%
  summarise(mean_price = mean(price), min_price= min(price), max_price = max(price), n = n())

Airbnb_n_accommodates <- ggplot(data = data, aes(x=n_accommodates, y=price)) +
  geom_point(size=1, colour=color[3], shape=16)+
  ylim(0,1500)+
  xlim(2,6)+
  labs(x="Number of people accomodated",y="Price")+
  geom_smooth(method="lm", colour=color[1], se=FALSE)+
  theme_bg()
Airbnb_n_accommodates
```